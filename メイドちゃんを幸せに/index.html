<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>あなたのお家の異種メイド</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ui-window-bg: rgba(230, 226, 211, 0.7); 
            --ui-accent: #3e3a39; 
            --btn-bg: rgba(230, 226, 211, 0.9);
            --slot-active: #8b0000;
            --noble-gold: linear-gradient(135deg, #d4af37 0%, #f9f1b0 50%, #aa8412 100%);
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            background: #000; overflow: hidden; 
            font-family: 'Shippori Mincho', serif;
            display: flex; align-items: center; justify-content: center;
        }
        
        #game-viewport {
            position: absolute; 
            width: 1400px; 
            height: 800px;
            background: #000; 
            overflow: hidden;
            flex-shrink: 0;
            transform-origin: center center;
        }

        .screen { position: absolute; inset: 0; display: none; background: #000; }
        .screen.active { display: block; }

        /* TAP TO START */
        #startup-overlay {
            position: absolute; inset: 0; background: #000; z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 50px; cursor: pointer; letter-spacing: 5px;
        }

        /* レイヤー管理 */
        #message-area { z-index: 500 !important; }
        #intimate-ui { z-index: 400 !important; }
        #side-menu { z-index: 300 !important; }
        #config-window { z-index: 1000 !important; display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; }

        /* 立ち絵の境界線バグ対策 */
        #char-layer, #npc-layer { 
            position: absolute; bottom: 0; height: 760px; pointer-events: none; object-fit: contain;
            image-rendering: -webkit-optimize-contrast; 
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            transform: translateZ(0); -webkit-transform: translateZ(0);
            outline: 1px solid transparent; border: none;
        }
        #char-layer { left: 200px; z-index: 5; animation: breathing 4s ease-in-out infinite; }
        #npc-layer { right: 100px; z-index: 4; display: none; opacity: 0; transition: 0.5s; }

        @keyframes breathing { 0%, 100% { transform: translateY(0) translateZ(0); } 50% { transform: translateY(-8px) translateZ(0); } }

        #title-screen { 
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('bg_title.jpg') center/cover no-repeat;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .game-title {
            color: #fff; font-size: 100px; font-weight: 700;
            text-shadow: 0 0 20px rgba(0,0,0,0.8), 2px 2px 10px #aa8412;
            margin-bottom: 80px; text-align: center;
        }

        #intro-screen { background: #000; color: #fff; display: flex; align-items: center; justify-content: center; padding: 100px; cursor: pointer; }
        #intro-text { font-size: 32px; line-height: 2.2; text-align: center; max-width: 1000px; transition: opacity 0.5s ease; white-space: pre-wrap; pointer-events: none;}

        .noble-btn {
            background: var(--noble-gold); border: 4px double #5c4b12; border-radius: 4px;
            color: #3e3a39; padding: 25px 80px; font-size: 32px; font-weight: bold;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: 0.3s; font-family: inherit;
        }

        #selection-screen { background: #111; }
        .selection-container { display: flex; width: 100%; height: 100%; }
        .maid-card {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            cursor: pointer; transition: 0.5s; position: relative;
            border-left: 1px solid rgba(255,255,255,0.1); overflow: hidden;
        }
        .maid-card:hover { background: rgba(255,255,255,0.08); flex: 1.3; }
        .maid-card .maid-img { height: 95%; width: 100%; background-position: bottom center; background-repeat: no-repeat; background-size: contain; pointer-events: none; }
        .maid-name-plate { position: absolute; bottom: 50px; background: var(--ui-window-bg); padding: 15px 60px; font-size: 36px; border: 2px solid var(--ui-accent); pointer-events: none;}

        #bg-layer { position: absolute; inset: 0; background-size: cover; background-position: center; transition: 1s; z-index: 1;}
        
        .glass-window { background: var(--ui-window-bg); border: 1px solid var(--ui-accent); padding: 25px; color: var(--ui-accent); backdrop-filter: blur(4px); }
        #side-menu { position: absolute; top: 100px; right: 40px; width: 480px; }
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .action-btn { background: var(--btn-bg); border: 1px solid var(--ui-accent); padding: 15px 5px; cursor: pointer; font-family: inherit; font-size: 22px; display: flex; align-items: center; justify-content: center; }
        
        #message-area { position: absolute; bottom: 20px; left: 20px; right: 20px; height: 200px; cursor: pointer; }
        #message-text { font-size: 28px; line-height: 1.6; padding: 20px 100px; overflow-wrap: break-word; pointer-events: none; }

        #intimate-ui { position: absolute; top: 40px; left: 780px; width: 580px; display: none; flex-direction: column; gap: 12px; }
        .h-group { background: rgba(0,0,0,0.4); padding: 15px; border: 1px solid rgba(255,255,255,0.5); color: #fff; backdrop-filter: blur(2px); }
        .stamina-container { width: 100%; height: 25px; background: rgba(0,0,0,0.5); border: 1px solid #fff; margin-top: 5px; overflow: hidden; }
        #stamina-fill { height: 100%; width: 100%; background: #2ecc71; transition: 0.3s; }
        
        .config-label { display: block; margin: 15px 0 5px; font-weight: bold; font-size: 20px;}
        input[type="range"] { width: 100%; cursor: pointer; height: 20px;}

        .hidden { display: none !important; }
        .tap-effect {
            position: absolute; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.6);
            border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%);
            animation: tap-animate 0.5s ease-out forwards; z-index: 9999;
        }
        @keyframes tap-animate { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 100px; height: 100px; opacity: 0; } }
    </style>
</head>
<body onmousedown="createTapEffect(event)">

<div id="game-viewport">
    <div id="startup-overlay" onclick="onStartupClick()">
        TAP TO START
    </div>

    <div id="title-screen" class="screen">
        <h1 class="game-title">あなたのお家の<br>異種メイド</h1>
        <button class="noble-btn" onclick="startIntro()">物語を始める</button>
    </div>

    <div id="intro-screen" class="screen" onclick="handleIntroClick()">
        <div id="intro-text"></div>
    </div>

    <div id="selection-screen" class="screen">
        <div class="selection-container">
            <div class="maid-card" onclick="selectMaid('sayo')">
                <div class="maid-img" style="background-image: url('sayo_normal.png');"></div>
                <div class="maid-name-plate">サヨ</div>
            </div>
            <div class="maid-card" onclick="selectMaid('kokoa')">
                <div class="maid-img" style="background-image: url('kokoa_normal.png');"></div>
                <div class="maid-name-plate">ここあ</div>
            </div>
        </div>
    </div>

    <div id="config-window" class="glass-window">
        <h2 style="margin:0; border-bottom:2px solid #333; padding-bottom:10px;">設定</h2>
        <label class="config-label">BGM音量</label>
        <input type="range" id="vol-bgm" min="0" max="1" step="0.1" value="0.5" onchange="updateVolume()">
        <label class="config-label">ボイス音量</label>
        <input type="range" id="vol-voice" min="0" max="1" step="0.1" value="1.0">
        <br><br>
        <button class="action-btn" style="width:100%" onclick="toggleConfig()">閉じる</button>
    </div>

    <div id="naming-screen" class="screen">
        <div class="glass-window" style="width: 450px; margin: 150px auto; text-align: center;">
            <p style="font-size:20px;">彼女に新しい名と居場所を。</p>
            <p style="margin:10px">主人の名</p><input type="text" id="master-name" value="ご主人様" style="width:80%; font-size: 24px;">
            <p style="margin:10px">彼女の名</p><input type="text" id="maid-name" value="" style="width:80%; font-size: 24px;"><br><br>
            <button class="action-btn" style="width: 100%;" onclick="finalizeNaming()">屋敷へ連れ帰る</button>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div id="bg-layer"></div>
        <img id="npc-layer" src="">
        <img id="char-layer" src="">
        
        <div id="time-indicator" style="position: absolute; top: 20px; right: 40px; display: flex; gap: 8px; z-index: 100; padding: 10px 20px; background: var(--ui-window-bg); border: 2px solid var(--ui-accent);">
            <div style="display: flex; align-items: center; gap: 8px;">朝<div class="time-slot" id="slot-0" style="width:30px;height:15px;border:1px solid #333"></div><div class="time-slot" id="slot-1" style="width:30px;height:15px;border:1px solid #333"></div></div>
            <div style="display: flex; align-items: center; gap: 8px;">昼<div class="time-slot" id="slot-2" style="width:30px;height:15px;border:1px solid #333"></div><div class="time-slot" id="slot-3" style="width:30px;height:15px;border:1px solid #333"></div></div>
            <div style="display: flex; align-items: center; gap: 8px;">夜<div class="time-slot" id="slot-4" style="width:30px;height:15px;border:1px solid #333"></div><div class="time-slot" id="slot-5" style="width:30px;height:15px;border:1px solid #333"></div></div>
        </div>

        <div id="side-menu" class="glass-window">
            <div style="border-bottom: 2px solid #333; margin-bottom: 15px; font-weight: bold; display: flex; justify-content: space-between; font-size: 24px;">
                <span id="display-maid-name">NAME</span><span id="display-day">Day 1</span>
            </div>
            <div class="button-grid">
                <button class="action-btn" onclick="handleAction('talk')">会話</button>
                <button class="action-btn" onclick="handleAction('pat')">スキンシップ</button>
                <button class="action-btn" onclick="handleAction('out')">外出</button>
                <button class="action-btn" onclick="handleAction('service')">ご奉仕</button>
                <button class="action-btn" onclick="handleAction('dress')">着替え</button>
                <button class="action-btn" onclick="toggleConfig()">設定</button>
                <button class="action-btn hidden" id="btn-sleep" style="grid-column: span 2;" onclick="handleBed()">ベッドへ</button>
            </div>
        </div>

        <div id="intimate-ui">
            <div class="h-group">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>彼女の余力</span><span id="stamina-text">100</span></div>
                <div class="stamina-container"><div id="stamina-fill"></div></div>
            </div>
            <div class="h-group">
                <div style="border-bottom:1px solid #fff; margin-bottom:10px; font-weight:bold;">愛撫</div>
                <div class="button-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <button class="action-btn h-btn" onclick="hAction('kiss')">キス</button>
                    <button class="action-btn h-btn" onclick="hAction('breast')">胸</button>
                    <button class="action-btn h-btn" onclick="hAction('clit')">陰核</button>
                </div>
            </div>
            <div class="h-group">
                <div style="border-bottom:1px solid #fff; margin-bottom:10px; font-weight:bold;">行為</div>
                <div class="button-grid">
                    <button class="action-btn h-btn" onclick="hAction('finger')">指入れ</button>
                    <button class="action-btn h-btn" onclick="hAction('insert')">挿入</button>
                    <button class="action-btn h-btn hidden" id="btn-naka" onclick="hAction('naka')">中だし</button>
                    <button class="action-btn h-btn hidden" id="btn-bukkake" onclick="hAction('bukkake')">ぶっかけ</button>
                </div>
            </div>
            <div class="button-grid" style="margin-top:10px;">
                <button class="action-btn" style="background:#555; color:#fff;" onclick="endIntimacy()">終了</button>
                <button class="action-btn" onclick="hAction('check')">様子</button>
            </div>
        </div>

        <div id="message-area" class="glass-window" onclick="handleMsgClick()">
            <div id="message-text">...</div>
        </div>
    </div>
</div>

<script>
    let audioCtx = null;
    let currentTypingTargetId = ""; 

    function onStartupClick() {
        initAudio();
        document.getElementById('startup-overlay').style.display = 'none';
        showScreen('title-screen');
    }

    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playTypeSound(pitch = 1.0) {
        if (!audioCtx) return;
        const vol = document.getElementById('vol-voice').value;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(440 * pitch, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(0.5 * vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    function updateVolume() { if (currentBGM) currentBGM.volume = document.getElementById('vol-bgm').value; }
    function toggleConfig() { const win = document.getElementById('config-window'); win.style.display = (win.style.display === 'block') ? 'none' : 'block'; }
    function createTapEffect(e) { const ef = document.createElement('div'); ef.className='tap-effect'; ef.style.left=`${e.clientX}px`; ef.style.top=`${e.clientY}px`; document.body.appendChild(ef); setTimeout(()=>ef.remove(), 500); }

    const AUDIO = { bgm_intro: 'bgm_intro.mp3', bgm_daily: 'bgm_daily.mp3', bgm_h: 'bgm_h.mp3', se_insert: 'se_insert.mp3', se_naka: 'se_naka.mp3' };
    const ASSETS = { 
        bg: { morning: 'bg_morning.jpg', noon: 'bg_noon.jpg', evening: 'bg_evening.jpg', night: 'bg_night.jpg', bed: 'bg_bed.jpg', street: 'bg_STREET.JPG' },
        maid: { sayo: 'sayo_normal.png', kokoa: 'kokoa_normal.png', sayo_nude: 'sayo_nude.png', kokoa_nude: 'kokoa_nude.png', sayo_h: 'sayo_h.png', kokoa_h: 'kokoa_h.png' },
        npc: { anu: 'anu.png', chief: 'chief.png', momoki: 'momoki.png', homu: 'homu.png' }
    };

    let state = { masterName: "ご主人様", maidName: "", maidType: "sayo", day: 1, timeIndex: 0, love: 0, mode: "normal", stamina: 100, nakaCount: 0, dress: "normal" };
    let currentBGM = null;
    let dialogueCallback = null;
    let introIdx = 0;
    let isTyping = false;
    let typingTimer = null;
    let currentFullText = "";

    const INTRO_LINES = ["冷たい雨が降る、薄暗い奴隷市場の片隅。", "そこには、『商品』にすらなれなかった異種族の少女がいた。", "店主は吐き捨てるように言う。\n「そいつは欠陥品だ。言葉も話さねえ、愛想もねえ、ただのゴミだよ」", "檻に閉じ込められ、震える彼女の瞳には、一切の光がなかった。", "……放っておけなかった。", "あなたは金貨を投げ、その少女を買い取った。", "あの日、あなたが救い出したのは……"];

    const DIALOGUES = {
        sayo: {
            pitch: 0.7,
            morning: [
                "おはようございます、{m}。……あ、いえ、私は捨てられた身。何でも命じてください。",
                "……夢を見ていました。あなたが私をまた捨てる夢を。……今は、ここに居てもいいのですね？",
                "朝食ですね。あなたに捨てられないよう、心を込めて作りました。",
                "{m}……今朝も、私の隣にいてくださって嬉しいです。……夢じゃ、ないんですよね？"
            ],
            talk: [
                "私はあなたの所有物です。……他の方を見ないでください。私だけを、見ていてほしいのです。",
                "掃除も洗濯も、完璧にこなします。ですから……ずっと側に置いてください。",
                "{m}、もし私が役に立たなくなったら……その時は、殺してください。他の誰かに渡されるのは、耐えられません。",
                "……あなたの匂いがするこの屋敷が、私にとっての世界のすべてです。",
                "奴隷市場では、ただ死を待つだけでした。光をくれたのは、{m}……あなただけです。"
            ],
            pat: [
                "……ぁ、温かい。……もっと、もっと撫でてください。あなたの手の温もりがないと、不安なのです。",
                "私が……嬉しいと思ってもいいのでしょうか。捨てられたゴミだった、この私が……。",
                "……離さないでくださいね？ 絶対に。絶対に……。",
                "あなたの手の跡が残るくらい……もっと、強く触れてくださっても良いのですよ？"
            ],
            pat_nude: [
                "ぁ……裸の私を、そんなに慈しんでくださるなんて……。私は、あなたの物です……。",
                "……もっと、撫でてください。あなたの手の届かない場所なんてありません。"
            ],
            service: [
                "お疲れですか、{m}？ 汚れた場所はありませんか？ 私の視界に映るすべてを、私が清めて差し上げます。",
                "私の存在意義は、{m}に尽くすことだけです。……どうか、私を使い潰してください。",
                "膝枕……よろしいのですか？ ……あぁ、嬉しい。こうしてあなたの重みを感じられるのが、一番のご奉仕です。"
            ],
            service_nude: ["裸で、あなたにお仕えする……。これこそが、捨てられた私の真実の姿。……どうぞ、何なりと。"],
            dress_nude: "……あ、裸、ですか……？ わかりました。……少し恥ずかしいですが、すべてをさらけ出します。",
            dress_normal: "メイド服を……。ありがとうございます。背中のリボン、結んでいただけますか？",
            h_kiss: ["ん……っ。マスターの唇……とても熱くて、蕩けてしまいそうです……。", "……ん、ちゅ。もっと……もっと慈しんでください。私は、あなたの所有物なのですから。"],
            h_breast: ["ぁ……胸、触られるの……好きです。あなたの手の重みを、もっと刻んでください。", "……っ！ 乳房まで、あなたのものに。……嬉しいです。汚してください、マスター。"],
            h_clit: ["ひゃあぁっ！ そこ……っ、そこはダメ……あ、あぁぁ！ 脳が、真っ白に……っ！", "……っ、あ。敏感なところ……マスターに、全部、握られて……ふぁあ！"],
            h_finger: ["……指、入ってきました。私の中を、あなたの形に作り変えて……もっと深く……っ！", "あぁぁっ！ 指だけで……こんな……。私をめちゃくちゃにしてください！"],
            h_insert: "あぁ……っ、あつい……。{m}の熱いところが、私の中を、壊していくみたいで……っ！",
            h_naka_1: "あぁっ！ 溢れる……マスターの、熱いのが……っ！ これで私は、あなたのものです……！",
            h_naka_repeat: "ひゃぁぁぁっ！ また、きた……っ！ 嬉しい……もっと中を汚して……私を塗り潰してぇ！",
            h_bukkake: "んっ、ぁ……。外に……勿体ないけれど、あなたの汚れなら、私、誇らしいです……。",
            h_faint: "……ぁ……あ……。……す、き……ます、た……（サヨは意識を失いました）",
            after_h: ["……はぁ、はぁ。……嬉しい。あなたの種で、私が満たされていく。……私はあなたのモノです。"],
            out_anu: ["アヌ「あら、サヨさん。今日もご主人様にべったりね。相変わらず一途なんだから。」", "サヨ「アヌさん……。べったりなのは当然です。私は、{m}に救われた身ですから。」", "アヌ「ふふっ、その執着心、ちょっと羨ましいわね。私ももっと甘え上手にならなくちゃ。」"],
            out_chief: ["メイド長「サヨさん、お仕事の調子はどうかしら？ 顔色が良くなったようで安心したわ。」", "サヨ「メイド長。ありがとうございます。{m}が毎日、私に役割と……愛をくださるおかげです。」", "メイド長「ふふ、そうね。あなたが幸せそうで何よりよ。主人のために頑張るのよ？」"],
            out_momoki: ["ももき「わぁ、サヨちゃん、今日もご主人様にべったり！ 羨ましいなー。」", "サヨ「ももきさん……。はい、{m}は私のすべてですから。」", "ももき「いいなー！ 帰ったらももきもご主人様にいっぱい愛してもらお！ 負けないんだから！」"],
            out_homu: ["ほむ「今日もご主人様とお散歩ですか？ 仲が良いな！」", "サヨ「ほむさん。ええ、{m}と一緒なら、どこへ行っても天国のように感じます。」", "ほむ「うむ。信頼できる主（あるじ）に命を捧げる。それこそが、我ら異種族が生き残る唯一の道よな」"]
        },
        kokoa: {
            pitch: 1.3,
            morning: [
                "……ん。……捨てられてない。……よかった。……おはよ、{m}。",
                "……お腹、すいた。……あなたが食べさせて。……じゃないと、食べない。",
                "……朝。……光がまぶしい。……あなたの影に、隠れさせて……？",
                "……おはよう。……今日も、私のこと……見ててくれる？"
            ],
            talk: [
                "……ねぇ、私のこと……好き？ ……嫌いになったら、その場で殺してね。",
                "……他の女の人の匂いがする。……嫌。……私だけを、嗅いで。",
                "……言葉、へただけど。……あなたがいれば、それだけでいい。",
                "……屋敷の外、行きたくない。……ここで、二人だけで、腐っていきたい……。",
                "……私、元々は商品にもならないゴミだったの。……拾ってくれて、ありがと……。",
                "……{m}がいないと、息ができない。……ほんとだよ？",
                "……私の首に、鎖をつけて。……あなたが持っていて。"
            ],
            pat: [
                "……んぅ。……これ、だいすき。……もっと、強く。跡が残るくらい……。",
                "……えへへ。……私はあなたのペット。……ずっと、飼っててね。",
                "……なでてくれないと、死んじゃう。……ほんとだよ？",
                "……ん。……もっと。……もっと、ぐちゃぐちゃにして……。",
                "……あつい。……{m}の手、溶けそう……。"
            ],
            pat_nude: [
                "……ん。……裸、触られるの、気持ちいい……。……もっと。……いっぱい。……ぐちゃぐちゃにして。",
                "……{m}の手、あつい。……裸、すき。……あなたのペット、だから。"
            ],
            service: [
                "……ご奉仕、する。……何がいい？ ……抱っこ？ ……それとも、耳のお掃除……？",
                "……{m}が喜ぶこと、いっぱいしたい。……捨てられないように、頑張るから。",
                "……疲れてるの？ ……じゃあ、私がぎゅーってしてあげる。……これが一番、ご奉仕になるでしょ？"
            ],
            service_nude: ["……裸、楽。……あなたも、脱ぐ……？ ……私が、脱がしてあげる。"],
            dress_nude: "……裸？ ……いいよ。……ほら。……全部、見て。……触って。",
            dress_normal: "……服。……ちょっと、寂しい。……また、すぐに脱がせてね？",
            h_kiss: ["ん……ちゅ。……おいしい。……{m}の味、全部、飲み込みたい……。", "……ん、ぷは。……もっと。もっと、ちゅーして。……寂しいの。"],
            h_breast: ["……ん。……胸、いっぱい触って。……これ, {m}のものだもん。", "……ぁ。……大きく、なっちゃう。……はずかしい。……苦しい。……でも、すき。"],
            h_clit: ["ひゃんっ！ ……そこ、へんな感じ……っ。……あつい、あついよ……！", "……んぅ！ ……いっちゃう。……こわれる。……もっと、いじめて……。"],
            h_finger: ["……なか。……ごりごり、する。……マスターの指、すごい。……もっと奥まで。", "ぁ……んっ！ ……なか、あつい。……ぐちゃぐちゃに、混ぜて……。"],
            h_insert: "……ん。……すご, いの……。……私の中, 全部、{m}で埋まった……。",
            h_naka_1: "ぁ……んっ！ ……でた。あったかい。……逃がさない。これ、私の宝物にする。",
            h_naka_repeat: "ふぁ……っ！？ ……また……だ。……すごい、いっぱい。ぐちゃぐちゃにして……。",
            h_bukkake: "……ん。……いっぱい, かかった。……あなたの匂い、身体に染みついちゃう……えへへ。",
            h_faint: "……もう, むり……（ここあは満足げに目を閉じました）",
            after_h: ["……ん。……あつい。……中、ドロドロ。……これ、私たちの証。"],
            out_anu: ["アヌ「ここあちゃん、こんにちは！ 今日も可愛いわねぇ。」", "ここあ「……ん。……アヌ。……やだ。……{m}は、私のだから。見ないで。」"],
            out_chief: ["メイド長「ここあ、ちゃんとご主人様のお役に立てているかしら？」", "ここあ「……ん。……大丈夫。……{m}は、私のこと、いっぱい甘やかしてくれるから。」"],
            out_momoki: ["ももき「わー！ ここあちゃん、今日もべったりじゃん！ 羨ましいなー。」", "ももき「わかってるって！ ももきも帰ったらご主人様に愛してもらお！ 楽しみだなー！」"],
            out_homu: ["ほむ「ここあ！ 見ていて微笑ましいぞ！」", "ここあ「……ん。……ほむ。……私は、{m}に拾われたの。ずっと、一緒にいるの。」", "ほむ「ああ、その一途な想い、ご主人様にもきっと伝わっているぞ。素敵な関係だな！」"]
        }
    };

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); const t = document.getElementById(id); if(t) t.classList.add('active'); }
    
    function playBGM(key) { 
        if(currentBGM){ currentBGM.pause(); currentBGM.currentTime = 0; currentBGM = null; } 
        currentBGM = new Audio(AUDIO[key]); currentBGM.loop = true; currentBGM.volume = document.getElementById('vol-bgm').value; currentBGM.play().catch(e=>{}); 
    }

    function startIntro() { introIdx=0; showScreen('intro-screen'); playBGM('bgm_intro'); nextIntro(); }
    function handleIntroClick() { nextIntro(); }

    function nextIntro() {
        if(isTyping){ skipTyping(); return; }
        if(introIdx < INTRO_LINES.length){
            displayMsgTyping(INTRO_LINES[introIdx], 1.0, 'intro-text');
            introIdx++;
        } else {
            showScreen('selection-screen');
        }
    }

    function selectMaid(type) { state.maidType=type; document.getElementById('maid-name').value=(type==='sayo'?"サヨ":"ここあ"); showScreen('naming-screen'); }
    function finalizeNaming() {
        state.masterName = document.getElementById('master-name').value || "ご主人様";
        state.maidName = document.getElementById('maid-name').value || (state.maidType==='sayo'?"サヨ":"ここあ");
        document.getElementById('display-maid-name').innerText = state.maidName;
        playBGM('bgm_daily'); state.day=1; state.timeIndex=0; updateUI(); showScreen('main-screen');
        displayMsg(`${state.maidName}「${getDialogue('morning')}」`);
    }

    function displayMsg(txt) {
        if(!txt || txt === "undefined") txt = "（静かにあなたを見つめています）";
        const processedTxt = txt.replace(/{m}/g, state.masterName);
        const pitch = DIALOGUES[state.maidType] ? DIALOGUES[state.maidType].pitch : 1.0;
        displayMsgTyping(processedTxt, pitch, 'message-text');
    }

    function displayMsgTyping(txt, pitch, targetId) {
        if(typingTimer) clearInterval(typingTimer);
        isTyping = true; currentFullText = txt; currentTypingTargetId = targetId; 
        const el = document.getElementById(targetId); if(!el) return;
        el.innerText = ""; let i = 0;
        typingTimer = setInterval(() => {
            if(i < txt.length){
                el.innerText += txt[i];
                if(txt[i] !== " " && txt[i] !== "\n" && txt[i] !== "　") playTypeSound(pitch);
                i++;
            } else { clearInterval(typingTimer); isTyping = false; }
        }, 50);
    }

    function skipTyping() {
        clearInterval(typingTimer);
        const el = document.getElementById(currentTypingTargetId);
        if(el) el.innerText = currentFullText;
        isTyping = false;
    }

    function handleMsgClick() {
        initAudio();
        if(isTyping){ skipTyping(); return; }
        if(dialogueCallback){ const cb = dialogueCallback; dialogueCallback = null; cb(); }
    }

    function getDialogue(cat) { const pool = DIALOGUES[state.maidType][cat]; return Array.isArray(pool) ? pool[Math.floor(Math.random()*pool.length)] : pool; }

    function handleAction(type) {
        if(isTyping) return;
        if(state.timeIndex > 5){ handleBed(); return; }
        if(type==='talk'){ state.love+=1; displayMsg(`${state.maidName}「${getDialogue('talk')}」`); }
        else if(type==='pat'){ state.love+=2; displayMsg(`${state.maidName}「${getDialogue(state.dress==='nude'?'pat_nude':'pat')}」`); }
        else if(type==='service'){ state.love+=4; displayMsg(`${state.maidName}「${getDialogue(state.dress==='nude'?'service_nude':'service')}」`); }
        else if(type==='out'){ startOuting(); return; }
        else if(type==='dress'){ handleDress(); return; }
        state.timeIndex++; updateUI();
    }

    function startOuting() {
        const pool = ['anu', 'chief', 'momoki', 'homu'];
        const npcType = pool[Math.floor(Math.random()*pool.length)];
        const lines = DIALOGUES[state.maidType]['out_' + npcType] || ["（散策しています）"];
        document.getElementById('side-menu').style.visibility="hidden";
        const bg = document.getElementById('bg-layer');
        bg.style.backgroundImage = `url('${ASSETS.bg.street}')`;
        bg.style.backgroundColor = 'transparent';
        const npcLayer = document.getElementById('npc-layer');
        npcLayer.src = ASSETS.npc[npcType];
        npcLayer.style.display = "block";
        setTimeout(() => npcLayer.style.opacity = 1, 10);
        let lIdx = 0;
        const seq = () => {
            if(lIdx < lines.length){ displayMsg(lines[lIdx]); lIdx++; dialogueCallback = seq; }
            else {
                npcLayer.style.opacity = 0;
                setTimeout(() => npcLayer.style.display = "none", 500);
                state.timeIndex++; state.love += 5; updateUI();
                displayMsg(`${state.maidName}「……帰りましょう、{m}。やっぱり屋敷が一番落ち着きます。」`);
            }
        };
        seq();
    }

    function handleDress() {
        const c = confirm("裸にしますか？");
        state.dress = c ? "nude" : "normal";
        displayMsg(`${state.maidName}「${c ? "……わかりました。すべてさらけ出します。" : "メイド服を着ますね。"}」`);
        state.timeIndex++; updateUI();
    }

    function handleBed() {
        if(state.love >= 20){
            const lines = state.maidType === 'sayo' ? ["……あの、捨てないで。","私をめちゃくちゃにして、あなたの所有物だと刻んでください……。"] : ["……ねぇ。……もっと、あなたを感じたい。","……壊れるくらい、全部。"];
            document.getElementById('side-menu').style.visibility="hidden";
            let lIdx=0;
            const seq = () => {
                if(lIdx < lines.length){ displayMsg(`${state.maidName}「${lines[lIdx]}」`); lIdx++; dialogueCallback=seq; }
                else { startIntimacy(); }
            };
            seq();
        } else { nextDay(); }
    }

    function startIntimacy() {
        state.mode="h"; state.stamina=100; state.nakaCount=0;
        const bg = document.getElementById('bg-layer');
        bg.style.backgroundImage = 'none';
        bg.style.backgroundColor = '#000';
        const char=document.getElementById('char-layer');
        char.src=ASSETS.maid[state.maidType+"_h"]; char.style.left="0px";
        playBGM('bgm_h'); document.getElementById('intimate-ui').style.display="flex";
        updateStaminaUI(); displayMsg(`震える${state.maidName}を抱き寄せ、深く繋がりました……。`);
    }

    function hAction(act) {
        if(isTyping) return;
        const char=document.getElementById('char-layer');
        char.src=`${state.maidType}_${act}.jpg`; char.onerror=()=>{char.src=ASSETS.maid[state.maidType+"_h"]; char.onerror=null;};
        let cost = 10; let msg = ""; const d = DIALOGUES[state.maidType];

        if(act==='kiss'){ cost=-15; msg = `${state.maidName}「${getDialogue('h_kiss')}」`; }
        else if(act==='breast'){ cost=10; msg = `${state.maidName}「${getDialogue('h_breast')}」`; }
        else if(act==='clit'){ cost=12; msg = `${state.maidName}「${getDialogue('h_clit')}」`; }
        else if(act==='finger'){ cost=15; msg = `${state.maidName}「${getDialogue('h_finger')}」`; }
        else if(act==='insert'){ cost=20; msg=`${state.maidName}「${getDialogue('h_insert')}」`; playSE('se_insert'); document.getElementById('btn-naka').classList.remove('hidden'); document.getElementById('btn-bukkake').classList.remove('hidden'); }
        else if(act==='naka'){ 
            cost=35; state.nakaCount++; playSE('se_naka'); 
            msg=(state.nakaCount===1)?`${state.maidName}「${DIALOGUES[state.maidType].h_naka_1}」` : `${state.maidName}「${DIALOGUES[state.maidType].h_naka_repeat}」`; 
        }
        else if(act==='bukkake'){ cost=25; msg=`${state.maidName}「${DIALOGUES[state.maidType].h_bukkake}」`; playSE('se_naka'); }
        else if(act==='check'){ cost=0; msg=`${state.maidName}は蕩けた表情であなたの名を呼び込んでいます。`; }

        state.stamina -= cost; if(state.stamina > 100) state.stamina = 100;
        if(state.stamina <= 0){ state.stamina = 0; updateStaminaUI(); faint(); } else { updateStaminaUI(); displayMsg(msg); }
    }

    function faint() { 
        displayMsg(`${state.maidName}「${DIALOGUES[state.maidType].h_faint}」`); 
        document.getElementById('intimate-ui').style.display="none"; 
        dialogueCallback=()=>{ nextDay(); }; 
    }
    
    function endIntimacy() { if(confirm("行為を終了しますか？")) nextDay(); }
    function updateStaminaUI() { document.getElementById('stamina-text').innerText=state.stamina; const fill=document.getElementById('stamina-fill'); fill.style.width=state.stamina+"%"; fill.style.background=state.stamina<30?"#e74c3c":"#2ecc71"; }

    function updateUI() {
        document.getElementById('display-day').innerText = `Day ${state.day}`;
        for (let i = 0; i < 6; i++) { const s=document.getElementById(`slot-${i}`); if(s) s.style.background=(i<state.timeIndex)?'var(--slot-active)':'rgba(0,0,0,0.1)'; }
        
        const bgs = [ASSETS.bg.morning, ASSETS.bg.morning, ASSETS.bg.noon, ASSETS.bg.noon, ASSETS.bg.evening, ASSETS.bg.night];
        const bgLayer = document.getElementById('bg-layer');
        bgLayer.style.backgroundImage=`url('${bgs[state.timeIndex]}')`;
        bgLayer.style.backgroundColor = 'transparent';

        const char=document.getElementById('char-layer');
        char.src=(state.dress==="nude")?ASSETS.maid[state.maidType+"_nude"]:ASSETS.maid[state.maidType];
        char.style.left="200px";
        document.getElementById('btn-sleep').classList.toggle('hidden', state.timeIndex < 4);
        document.getElementById('side-menu').style.visibility="visible";
        document.getElementById('side-menu').classList.remove('hidden');
    }

    function nextDay() {
        state.day++; state.timeIndex=0; state.stamina=100; state.mode="normal";
        if(currentBGM){ currentBGM.pause(); currentBGM.currentTime = 0; currentBGM = null; } 
        document.getElementById('intimate-ui').style.display="none";
        document.getElementById('btn-naka').classList.add('hidden');
        document.getElementById('btn-bukkake').classList.add('hidden');
        playBGM('bgm_daily'); updateUI();
        displayMsg(`${state.maidName}「${getDialogue('morning')}」`);
    }

    function updateScale() { const v=document.getElementById('game-viewport'); const s=Math.min(window.innerWidth/1400,window.innerHeight/800); v.style.transform=`scale(${s})`; }
    window.addEventListener('resize', updateScale); window.addEventListener('load', updateScale);
</script>
</body>
</html>